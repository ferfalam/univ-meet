<template>
  <div id="app">
      <NavigationStudent  :user="user" />
      <div class="row m-3 content-all">
        <div class="col col-sm-12 col-lg-3 friend-content">
          <div class="row align-items-center">
            <div class="col col-3">
              <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
              width="25px" height="25px" viewBox="0 0 1280.000000 1258.000000"
              preserveAspectRatio="xMidYMid meet">
              <metadata>
              Created by potrace 1.15, written by Peter Selinger 2001-2017
              </metadata>
              <g transform="translate(0.000000,1258.000000) scale(0.100000,-0.100000)"
              fill="#000000" stroke="none">
              <path d="M8450 12560 c-74 -4 -187 -15 -250 -24 -63 -9 -135 -19 -160 -21 -25
              -3 -74 -13 -110 -21 -36 -9 -76 -18 -90 -20 -168 -29 -502 -135 -736 -235
              -110 -46 -337 -158 -393 -193 -20 -13 -70 -43 -111 -67 -165 -96 -439 -294
              -560 -403 -120 -108 -433 -430 -490 -502 -8 -11 -40 -51 -70 -89 -31 -39 -70
              -90 -86 -115 -17 -25 -60 -88 -96 -140 -57 -83 -248 -409 -248 -423 0 -3 -17
              -43 -39 -89 -131 -282 -195 -464 -273 -771 -37 -149 -52 -235 -78 -442 -27
              -226 -40 -392 -40 -525 0 -162 37 -585 60 -690 6 -25 17 -79 25 -120 24 -120
              52 -241 70 -300 59 -196 111 -344 164 -465 10 -22 24 -56 31 -75 57 -145 257
              -497 398 -701 177 -255 523 -628 736 -794 22 -16 64 -51 95 -76 143 -118 462
              -319 676 -426 266 -134 630 -267 865 -318 8 -2 44 -10 80 -19 36 -8 79 -17 95
              -20 122 -22 217 -37 236 -38 13 0 49 -5 79 -10 135 -22 476 -33 677 -21 109 6
              221 14 248 18 28 4 70 9 95 11 95 10 225 34 425 79 70 16 228 60 270 75 28 10
              68 24 90 31 41 12 209 77 280 108 22 10 56 24 75 32 63 24 302 149 409 214
              148 90 377 247 435 300 6 6 36 30 66 53 159 124 426 390 550 548 17 21 48 59
              68 83 20 24 63 80 94 125 31 45 65 92 75 106 37 49 123 189 123 199 0 6 5 11
              10 11 6 0 10 4 10 10 0 5 15 33 33 62 32 50 187 358 187 371 0 4 11 30 24 59
              13 29 38 94 56 143 18 50 37 99 41 110 16 34 81 260 110 380 74 300 124 796
              107 1065 -14 233 -29 414 -38 460 -5 25 -14 79 -20 120 -6 41 -20 113 -31 160
              -11 47 -29 123 -40 170 -18 74 -44 161 -94 315 -19 57 -63 172 -85 220 -10 22
              -28 63 -40 90 -167 379 -365 691 -648 1025 -63 75 -332 344 -411 411 -35 30
              -69 59 -75 64 -29 26 -127 101 -254 192 -102 72 -407 255 -507 303 -38 18 -97
              46 -130 62 -194 96 -627 243 -836 283 -44 9 -134 26 -154 30 -58 12 -88 16
              -175 26 -52 5 -129 15 -170 20 -101 14 -464 19 -630 9z m540 -505 c200 -18
              323 -36 478 -71 1540 -345 2671 -1637 2803 -3203 15 -177 6 -601 -15 -755 -57
              -401 -159 -743 -325 -1091 -428 -895 -1240 -1594 -2186 -1880 -501 -151 -1044
              -193 -1555 -119 -1437 208 -2608 1262 -2965 2669 -83 328 -109 568 -102 950 7
              348 38 586 113 863 225 830 748 1560 1466 2043 664 448 1501 665 2288 594z"/>
              <path d="M8010 11380 c-8 -5 -10 -10 -5 -10 6 0 17 5 25 10 8 5 11 10 5 10 -5
              0 -17 -5 -25 -10z"/>
              <path d="M7915 11349 c-54 -22 -75 -36 -35 -24 37 12 107 44 95 44 -5 0 -32
              -9 -60 -20z"/>
              <path d="M7810 11305 c-14 -8 -20 -14 -15 -14 6 0 21 6 35 14 14 8 21 14 15
              14 -5 0 -21 -6 -35 -14z"/>
              <path d="M7760 11280 c-9 -6 -10 -10 -3 -10 6 0 15 5 18 10 8 12 4 12 -15 0z"/>
              <path d="M7648 11224 c-38 -20 -36 -28 2 -9 17 9 30 18 30 20 0 7 -1 6 -32
              -11z"/>
              <path d="M5180 9086 c0 -2 8 -10 18 -17 15 -13 16 -12 3 4 -13 16 -21 21 -21
              13z"/>
              <path d="M4953 6236 c-154 -50 -243 -170 -243 -326 0 -91 28 -164 88 -231 l46
              -52 -134 -128 c-74 -71 -138 -128 -142 -129 -4 0 -45 39 -92 88 l-85 87 -178
              -177 c-98 -97 -1008 -997 -2021 -2001 l-1844 -1824 -50 -6 c-251 -30 -383
              -335 -231 -534 19 -25 222 -246 450 -489 375 -401 422 -447 477 -474 228 -112
              487 46 487 297 l0 62 1497 1482 c823 816 1729 1713 2012 1996 l515 513 -97 97
              -97 98 135 126 135 126 37 -35 c64 -61 134 -87 232 -87 71 0 94 4 141 26 194
              91 258 340 131 507 -19 26 -137 155 -261 287 -125 132 -311 331 -415 443 -162
              173 -198 207 -251 233 -74 36 -176 47 -242 25z"/>
              </g>
              </svg>
            </div>
            <div class="col col-9">
              <input type="text" v-on:input="search_student" class="form-control search-input">
            </div>
          </div>
          <div class="content">
            <FriendElmt  v-for="friend in friendselmtprops" :key="friend.friend.id" :friend="friend"/>
          </div>
        </div>
        
        <div class="col col-sm-12 col-lg-6 post-content">
          <div id="new-post">
            <div class="row align-items-center text-center">
              <div class="col col-9">
                <textarea type="text" v-model="new_post.content" class="form-control text-post-content" placeholder="Publier un post"></textarea>
              </div>          
              <div class="col col-3">
                <input type="file" v-on:change="onFileChange" class="form-control-file card-image-input" id="post_image" hidden/>
                <img src="/images/like/3.png" alt="" v-on:click="setFile">
              </div>
            </div>
            <div v-if="file_error" class="text-danger">
              <ul class="text-danger">
                  <li >
                      <small>{{file_error}}</small>
                  </li>
              </ul>
            </div>
            <div class="row justify-content-center my-2">
              <button v-on:click="publier" class="btn btn-outline-primary w-75">Publier</button>
            </div>
          </div>
          
          <PostElmt v-for="post in postselmtprops" :key="post.post.id" :elmt="post" :user="user" />
        </div>

        <div class="col col-sm-12 col-lg-3 favorite-content">
          <p class="h3">Mes favoris</p>
          <FavoriteElmt v-for="favorite in favoriteselmtprops" :favorite="favorite" :key="favorite.id" :user="user" />
        </div>
      </div>
      <div class="toast toast-danger text-light" :class="toast.color">
        <div class="toast-header">
            {{toast.header}}
        </div>
        <div class="toast-body">
            {{toast.body}}
        </div>
      </div>
      <Footer />
  </div>
</template>
<script>
  import axios from 'axios'
  import NavigationStudent from '../partials/navigationstudent.vue'
  import Footer from '../partials/footer.vue'
  import FriendElmt from './friendelmt.vue'
  import FavoriteElmt from './favoriteselmt.vue'
  import PostElmt from './postcard.vue'
  export default {
    name: "IndexStudent",

    mounted() {
      axios.defaults.headers.common['X-CSRF-Token'] = document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    
    props: {
      landing_data: Object,
      user: Object
    },

    mounted() {
      this.setFriendsElmtProps()
      this.setFavoritesElmtProps()
      this.setPostsElmtProps()
    },

    components: {
      NavigationStudent,
      Footer,
      FriendElmt,
      FavoriteElmt,
      PostElmt
    },

    methods:{
      publier: function () {
        // console.log(this.new_post)
        let _this=this
        axios.post('/students/posts', this.new_post)
        .then(function (response) {
            if (response.data.status == 200) {
                _this.errors = {
                  content: null,
                  image: null,
                }
                _this.toast = response.data.toast
                _this.data_infos.posts = response.data.post
                _this.setPostsElmtProps()
                $('.toast').toast({delay: 3000});
    $('.toast').toast('show');
                _this.new_post = {
                  content: '',
                  image: '',
                }
            }else{
                _this.errors = response.data.errors
            }
        })
      },

      setFile: function () {
        // console.log("setfile")
        document.getElementById("post_image").click()
      },

      setPostsElmtProps: function () {
        // console.log(this.favoriteselmtprops)
        this.postselmtprops = []
        this.data_infos.posts.forEach(post => {
          let temp = {
            post: post,
            favorite: false,
            owner: null
          }
          this.data_infos.students.forEach((student) => {
            if (post.student_id == student.id) {
              temp.owner = student
            }
          })
          this.favoriteselmtprops.forEach(favorite => {
            if (post.id == favorite.id) {
              temp.favorite = true
            }
          });
          this.postselmtprops.push(temp)
        });
      },

      setFriendsElmtProps: function () {
        this.data_infos.students.forEach((student) => {
          if (student.id != this.user.id) {
            let friends_elmt = {
              friend: student,
              university: this.data_infos.universities.filter((university) => (university.id == student.university_id))[0],
              field: this.data_infos.fields.filter((field) => (field.id == student.field_id))[0]
            }
            this.friendselmtprops.push(friends_elmt)
          }
        })
      },

      search_student: function (e) {
        if (e.target.value) {
          this.friendselmtprops = []
          this.data_infos.students.forEach((student) => {
            let fullname = student.lastname+" "+student.firstname
            if (student.id != this.user.id && fullname.toLowerCase().includes(e.target.value.toLowerCase())) {
              let friends_elmt = {
                friend: student,
                university: this.data_infos.universities.filter((university) => (university.id == student.university_id))[0],
                post: this.data_infos.posts.filter((post) => (post.id == student.post_id))[0]
              }
              this.friendselmtprops.push(friends_elmt)
            }
          })
        }else{
          this.friendselmtprops = []
          this.setFriendsElmtProps()
        }
      },

      setFavoritesElmtProps: function () {
        this.data_infos.posts.forEach(post => {
          this.data_infos.favorites.forEach(favorite => {
            if (favorite.post_id == post.id && favorite.student_id == this.user.id) {
              this.favoriteselmtprops.push(post)
            }
          });
        });
      },

      onFileChange: function (e) {
        let files = e.target.files || e.dataTransfer.files;

        if (files.length) {
            let files_tab = files[0].name.split(".")
            let files_extension = files_tab[files_tab.length - 1]
            if (['jpeg', "jpg", 'png'].includes(files_extension)) {
                this.createImage(files[0])
                this.file_error = null
            }else{
                this.file_error = "Le fichier doit être une image"
            }
        }else{
            this.file_error = "Le fichier doit être une image"
        }
      },

      createImage(file) {
        var image = new Image();
        var reader = new FileReader();
        var vm = this;

        reader.onload = (e) => {
            const formData = new FormData();
            const url = "https://api.cloudinary.com/v1_1/demo/image/upload";
            
            formData.append("file", e.target.result);
            formData.append("upload_preset", "docs_upload_example_us_preset");

            fetch(url, {
            method: "POST",
            body: formData
            })
            .then((response) => {
                return response.text();
            })
            .then((data) => {
                let data_json =  JSON.parse(data)
                vm.new_post.image = data_json.url;
            });
        };
        reader.readAsDataURL(file);
      },
    },

    data: function () {
      return {
        data_infos:this.landing_data,
        new_post:{
          content: null,
          image: null,
        },
        friendselmtprops: [],
        favoriteselmtprops: [],
        postselmtprops: [],
        file_error: null,
        toast: {
          header: '',
          body: '',
          color: ''
        }
      }
    }
  }
</script>

<style scoped>

.toast{
    position: fixed;
    right: 5px;
    top: 5px;
    z-index: 1;
}

.text-post-content{
    border: none;
    border-bottom: solid 1px;
    border-radius: 0;
}

.content-all{
  margin-top: 100px !important
}

.search-input{
  border-radius: 15px;
}

@media (min-width: 1100px) {
  .friend-content{
    overflow-y: scroll;
    max-height: 75vh;
    position: fixed;
  }
}

@media (max-width: 1100px) {
  .friend-content{
    overflow-y: scroll;
    max-height: 200px;
  }
}

@media (min-width: 1100px) {
  .post-content{
    margin: 0 25%
  }

  .favorite-content{
    position: fixed;
    right: 0;
    max-height: 75vh;
    overflow-y: scroll;
    direction: rtl;
  }
}

@media (max-width: 1100px) {
  .favorite-content{
    display: none;
  }
}

.friend-card, .favorite-card{
    border-radius: 10px;
    background-color: #f3f3f3;
    padding: 10px;
}

.friend-card:hover, .favorite-card:hover{
  box-shadow: 0px 0px 11px 2px #a7a7a7;
}

</style>